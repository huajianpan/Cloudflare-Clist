name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Generate Wrangler config
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WORKER_NAME: ${{ vars.WORKER_NAME }}
          WORKER_MAIN: ${{ vars.WORKER_MAIN }}
          COMPATIBILITY_DATE: ${{ vars.COMPATIBILITY_DATE }}
          D1_DATABASE_NAME: ${{ vars.D1_DATABASE_NAME }}
          D1_DATABASE_ID: ${{ vars.D1_DATABASE_ID }}
          D1_BINDING: ${{ vars.D1_BINDING }}
          D1_MIGRATIONS_DIR: ${{ vars.D1_MIGRATIONS_DIR }}
          OBSERVABILITY_ENABLED: ${{ vars.OBSERVABILITY_ENABLED }}
        run: |
          WORKER_NAME="${WORKER_NAME:-clist}"
          WORKER_MAIN="${WORKER_MAIN:-./workers/app.ts}"
          COMPATIBILITY_DATE="${COMPATIBILITY_DATE:-2025-04-04}"
          D1_DATABASE_NAME="${D1_DATABASE_NAME:-clist}"
          D1_BINDING="${D1_BINDING:-DB}"
          D1_MIGRATIONS_DIR="${D1_MIGRATIONS_DIR:-./migrations}"
          OBSERVABILITY_ENABLED="${OBSERVABILITY_ENABLED:-true}"

          if [ -z "$D1_DATABASE_ID" ]; then
            if [ -z "$CLOUDFLARE_API_TOKEN" ] || [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
              echo "Missing CLOUDFLARE_API_TOKEN or CLOUDFLARE_ACCOUNT_ID for D1 lookup." >&2
              exit 1
            fi
            D1_DATABASE_ID="$(npx wrangler d1 list --json | node -e "const fs=require('fs');const data=JSON.parse(fs.readFileSync(0,'utf8'));const name=process.env.D1_DATABASE_NAME;const hit=data.find(d=>d.name===name);if(!hit){process.exit(2)};process.stdout.write(hit.uuid);")"
            if [ $? -ne 0 ] || [ -z "$D1_DATABASE_ID" ]; then
              echo "Failed to find D1 database ID for name: $D1_DATABASE_NAME" >&2
              exit 1
            fi
          fi
          cat > wrangler.jsonc <<EOF
          {
            "\$schema": "node_modules/wrangler/config-schema.json",
            "name": "$WORKER_NAME",
            "main": "$WORKER_MAIN",
            "compatibility_date": "$COMPATIBILITY_DATE",
            "observability": { "enabled": $OBSERVABILITY_ENABLED },
            "d1_databases": [
              {
                "binding": "$D1_BINDING",
                "database_name": "$D1_DATABASE_NAME",
                "database_id": "$D1_DATABASE_ID",
                "migrations_dir": "$D1_MIGRATIONS_DIR"
              }
            ]
          }
          EOF

      - name: Sync Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "$ADMIN_USERNAME" | npx wrangler secret put ADMIN_USERNAME --config wrangler.jsonc
          echo "$ADMIN_PASSWORD" | npx wrangler secret put ADMIN_PASSWORD --config wrangler.jsonc
          echo "$WEBDAV_USERNAME" | npx wrangler secret put WEBDAV_USERNAME --config wrangler.jsonc
          echo "$WEBDAV_PASSWORD" | npx wrangler secret put WEBDAV_PASSWORD --config wrangler.jsonc

      - name: Apply D1 migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler d1 migrations apply ${{ vars.D1_DATABASE_NAME }} --remote --config wrangler.jsonc

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: >-
            deploy
            --config wrangler.jsonc
            --var "VALUE_FROM_CLOUDFLARE:${{ vars.VALUE_FROM_CLOUDFLARE }}"
            --var "SITE_TITLE:${{ vars.SITE_TITLE }}"
            --var "SITE_ANNOUNCEMENT:${{ vars.SITE_ANNOUNCEMENT }}"
            --var "CHUNK_SIZE_MB:${{ vars.CHUNK_SIZE_MB }}"
            --var "WEBDAV_ENABLED:${{ vars.WEBDAV_ENABLED }}"
