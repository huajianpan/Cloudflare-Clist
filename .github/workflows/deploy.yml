name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Sync Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "$ADMIN_USERNAME" | npx wrangler secret put ADMIN_USERNAME
          echo "$ADMIN_PASSWORD" | npx wrangler secret put ADMIN_PASSWORD
          echo "$WEBDAV_USERNAME" | npx wrangler secret put WEBDAV_USERNAME
          echo "$WEBDAV_PASSWORD" | npx wrangler secret put WEBDAV_PASSWORD

      - name: Apply D1 migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler d1 migrations apply clist --remote

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: >-
            deploy
            --var "VALUE_FROM_CLOUDFLARE:${{ vars.VALUE_FROM_CLOUDFLARE }}"
            --var "SITE_TITLE:${{ vars.SITE_TITLE }}"
            --var "SITE_ANNOUNCEMENT:${{ vars.SITE_ANNOUNCEMENT }}"
            --var "CHUNK_SIZE_MB:${{ vars.CHUNK_SIZE_MB }}"
            --var "WEBDAV_ENABLED:${{ vars.WEBDAV_ENABLED }}"
